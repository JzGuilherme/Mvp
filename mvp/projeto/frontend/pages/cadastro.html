<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ManUp - Cadastro</title>
  <link rel="stylesheet" href="../cstop/style.css">
  <link rel="stylesheet" href="dashboard.html">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <title>Man-Up - Registro</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../cstop/cadastro.css">

</head>
<body>
  <section id="register-page">
    <div class="register-container">
      <div class="info-panel">
  <img src="../imagens/Ellipse 1.svg" alt="Decorative background art" class="info-panel__bg-art">
  <img src="../imagens/Ellipse 2.svg" alt="Decorative background art" class="info-panel__bg-art2">
        <div class="info-panel__content">
          <h1>ManUp</h1>
          <p>Website Desenvolvido para a Saúde do Homem</p>
          
        </div>
      </div>
      <div class="form-panel">
        <form class="register-form" action="/cadastro" method="post">
          <div class="register-form__header">
            <h2>Olá!</h2>
            <p>Se Inscreva para Iniciar</p>
          </div>
          <!-- Notificação dinâmica (inserida via JS) -->
          <div id="notification" aria-live="polite" style="display:none; margin-bottom:12px; padding:10px; border-radius:6px;
              background:#e6f7ff; color:#034a6b; font-weight:600; text-align:center;
              box-shadow:0 1px 2px rgba(0,0,0,0.05);">
          </div>
          <div class="form-group">
            <div class="form-group__icon-wrapper">
              <img src="../imagens/Usuário.svg" alt="User icon" class="form-group__icon">
            </div>
            <input type="text" id="username" name="nome_completo" placeholder="Nome de Usuário" required>
          </div>
          <div class="form-group">
            <div class="form-group__icon-wrapper">
              <img src="../imagens/Email.svg" alt="Email icon" class="form-group__icon">
            </div>
            <input type="email" id="email" name="email" placeholder="Email" required>
          </div>
          <div class="form-group">
            <div class="form-group__icon-wrapper">
              <img src="../imagens/Senha.svg" alt="Password icon" class="form-group__icon">
            </div>
            <input type="password" id="password" name="password" placeholder="Senha" required>
            <button type="button" id="btn-register" class="toggle-password" aria-label="Mostrar senha" aria-pressed="false">
              <img class="eye-icon" src="../imagens/eye-close.png" alt="Ocultar senha">
            </button>
          </div>
          <script>
            (function () {
              var btn = document.getElementById('btn-register');
              var input = document.getElementById('password');
              if (!btn || !input) return;
              var eye = btn.querySelector('.eye-icon');

              btn.addEventListener('click', function (e) {
                e.preventDefault();
                if (input.type === 'password') {
                  input.type = 'text';
                  eye.src = '../imagens/eye-open.png';
                  eye.alt = 'Mostrar senha';
                  btn.setAttribute('aria-pressed', 'true');
                } else {
                  input.type = 'password';
                  eye.src = '../imagens/eye-close.png';
                  eye.alt = 'Ocultar senha';
                  btn.setAttribute('aria-pressed', 'false');
                }
              });
            })();
          </script>
          
          <!-- Script para envio via fetch, notificação e redirecionamento -->
          <script>
            (function () {
              const form = document.querySelector('.register-form');
              const notification = document.getElementById('notification');
              if (!form) return;

              function showNotification(text, type = 'info'){
                notification.style.display = 'block';
                notification.textContent = text;
                if(type === 'error'){
                  notification.style.background = '#ffe6e6';
                  notification.style.color = '#6b0303';
                } else {
                  notification.style.background = '#e6f7ff';
                  notification.style.color = '#034a6b';
                }
              }

              form.addEventListener('submit', async function(e){
                e.preventDefault();
                showNotification('Enviando cadastro...');

                const data = {
                  nome_completo: form.nome_completo ? form.nome_completo.value : (form.username ? form.username.value : ''),
                  email: form.email.value,
                  password: form.password.value
                };

                try {
                  const resp = await fetch('/cadastro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                  });

                  if (resp.ok) {
                    const json = await resp.json();
                    showNotification(json.message || 'Cadastro realizado com sucesso!');
                    // redirecionar para login após 1.8s
                    setTimeout(() => { window.location.href = '/'; }, 1800);
                  } else {
                    // tentar ler JSON de erro
                    let errorText = 'Erro ao cadastrar.';
                    try {
                      const err = await resp.json();
                      errorText = err.message || errorText;
                    } catch (e) {
                      const txt = await resp.text();
                      if (txt) errorText = txt;
                    }
                    showNotification(errorText, 'error');
                  }
                } catch (err) {
                  showNotification('Falha na conexão com o servidor.', 'error');
                  console.error('Erro no fetch de cadastro:', err);
                }
              });
            })();
          </script>
          <button type="submit" class="btn btn--primary">Registrar</button>
          <a href="../pages/login.html" class="forgot-password-link">Já Tenho Uma Conta</a>
        </form>
      </div>
    </div>
  </section>
</body>
</html>