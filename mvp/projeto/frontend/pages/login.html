<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Man-Up - Login</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins&display=swap" rel="stylesheet">
     <link rel="icon" type="image/png" href="../imagens/MAISLOGO.png"">  
  <link rel=" stylesheet" href="../cstop/login.css">
</head>

<body>
  <section id="login-page">
    <div class="login-container">
      <div class="info-panel">
        <img src="../imagens/Ellipse 1.svg" alt="Decorative background art" class="info-panel__bg-art">
        <img src="../imagens/Ellipse 2.svg" alt="Decorative background art" class="info-panel__bg-art2">
        <div class="info-panel__content">
          <h1>ManUp</h1>
          <p>Website Desenvolvido para a Saúde do Homem</p>
        </div>
      </div>
      <div class="form-panel">
        <form class="login-form" action="/login" method="post">
          <div class="login-form__header">
            <h2>Olá Novamente!</h2>
            <p>Bem-Vindo de Volta</p>
          </div>
          <div id="login-notification" aria-live="polite" style="display:none; margin-bottom:12px; padding:10px; border-radius:6px;
              background:#e6f7ff; color:#034a6b; font-weight:600; text-align:center; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
          </div>
          <div class="form-group">
            <div class="form-group__icon-wrapper">
              <img src="../imagens/Email.svg" alt="Email icon" class="form-group__icon">
            </div>
            <input type="email" id="email" name="email" placeholder="Email" required>
          </div>
          <div class="form-group">
            <div class="form-group__icon-wrapper">
              <img src="../imagens/Senha.svg" alt="Password icon" class="form-group__icon">
            </div>
            <input type="password" id="password" name="password" placeholder="Senha" required>
            <!-- toggle button placed inside the form-group; type="button" prevents accidental submit -->
            <button type="button" id="btn" class="toggle-password" aria-label="Mostrar senha" aria-pressed="false">
              <img class="eye-icon" src="../imagens/eye-close.png" alt="Ocultar senha">
            </button>
          </div>

          <script>
            // Password visibility toggle: swap input type and change icon src (keeps markup intact)
            (function () {
              var btn = document.getElementById('btn');
              var input = document.getElementById('password');
              var eye = btn.querySelector('.eye-icon');

              btn.addEventListener('click', function (e) {
                e.preventDefault();
                if (!input) return;

                if (input.type === 'password') {
                  input.type = 'text';
                  eye.src = '../imagens/eye-open.png';
                  eye.alt = 'Mostrar senha';
                  btn.setAttribute('aria-pressed', 'true');
                } else {
                  input.type = 'password';
                  eye.src = '../imagens/eye-close.png';
                  eye.alt = 'Ocultar senha';
                  btn.setAttribute('aria-pressed', 'false');
                }
              });
            })();
          </script>

          <script>

            const inputs = document.querySelectorAll('.form-group input');

          </script>

          <!-- Script para envio via fetch + redirecionamento ao dashboard -->
          <script>
            (function () {
              const form = document.querySelector('.login-form');
              const note = document.getElementById('login-notification');
              if (!form) return;

              function show(text, type = 'info') {
                note.style.display = 'block';
                note.textContent = text;
                if (type === 'error') {
                  note.style.background = '#ffe6e6'; note.style.color = '#6b0303';
                } else {
                  note.style.background = '#e6f7ff'; note.style.color = '#034a6b';
                }
              }

              form.addEventListener('submit', async function (e) {
                e.preventDefault();
                show('Tentando entrar...');

                const data = { email: form.email.value, password: form.password.value };

                try {
                  const resp = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(data)
                  });

                  if (resp.ok) {
                    const json = await resp.json();
                    show(json.message || 'Login bem-sucedido');

                    // ============ ADICIONE ISTO ============
                    // Verifica se o servidor enviou o 'nome' e salva
                    if (json.nome) {
                      localStorage.setItem('nomeUsuario', json.nome);
                    }
                    // ========================================

                    // redireciona para o dashboard se o backend indicar
                    if (json.redirect) {
                      setTimeout(() => { window.location.href = json.redirect; }, 800);
                    }
                  } else {
                    let errText = 'Erro no login.';
                    try { const ejson = await resp.json(); errText = ejson.message || errText; }
                    catch (ex) { const txt = await resp.text(); if (txt) errText = txt; }
                    show(errText, 'error');
                  }
                } catch (err) {
                  console.error('Erro no fetch de login:', err);
                  show('O Email ou a senha está incorreto.', 'error');
                }
              });
            })();
          </script>

          <button type="submit" class="btn btn--primary">Login</button>
          <a href="cadastro.html" class="forgot-password-link">Não Tenho Uma Conta</a>
          <a href="esquecisenha.html" class="forgot-password-link">Esqueci a senha.</a>
        </form>
      </div>
    </div>
  </section>
</body>

</html>