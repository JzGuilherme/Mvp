<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redefinir Senha</title>
    <link rel="stylesheet" href="../cstop/style.css" />
    <link rel="icon" type="image/png" href="../imagens/logo-perfect.jpg"">   
</head>

<body>
    <div class=" container">
    <h2>Crie Sua Nova Senha</h2>

    <form id="reset-form">
        <div class="password-wrapper">
            <label for="password">Nova Senha:</label>
            <div class="input-group">
                <input type="password" id="password" required />
                <button type="button" id="btn-register" class="toggle-password" aria-label="Mostrar senha" aria-pressed="false">
                    <img class="eye-icon" src="../imagens/eye-close.png" alt="Ocultar senha" />
                </button>
            </div>
        </div>

        <div class="password-wrapper">
            <label for="confirm-password">Confirmar Nova Senha:</label>
            <div class="input-group">
                <input type="password" id="confirm-password" required>
                <button type="button" id="btn-register2" class="toggle-password" data-target="confirm-password" aria-label="Mostrar senha" aria-pressed="false">
                    <img class="eye-icon" src="../imagens/eye-close.png" alt="Ocultar senha">
                </button>
            </div>
        </div>

        <button type="submit">Salvar Nova Senha</button>
        <p id="message" style="color: #6B7280"><strong>Crie uma senha forte!</strong></p>
        </div>

    </form>


    </div>

    <script>
        (function () {
            var btn = document.getElementById("btn-register");
            var input = document.getElementById("password");
            if (!btn || !input) return;
            var eye = btn.querySelector(".eye-icon");

            btn.addEventListener("click", function (e) {
                e.preventDefault();
                if (input.type === "password") {
                    input.type = "text";
                    eye.src = "../imagens/eye-open.png";
                    eye.alt = "Mostrar senha";
                    btn.setAttribute("aria-pressed", "true");
                } else {
                    input.type = "password";
                    eye.src = "../imagens/eye-close.png";
                    eye.alt = "Ocultar senha";
                    btn.setAttribute("aria-pressed", "false");
                }
            });
        })();
    </script>

    <script>
        (function () {
            var btn = document.getElementById("btn-register2");
            var input = document.getElementById("confirm-password");
            if (!btn || !input) return;
            var eye = btn.querySelector(".eye-icon");

            btn.addEventListener("click", function (e) {
                e.preventDefault();
                if (input.type === "password") {
                    input.type = "text";
                    eye.src = "../imagens/eye-open.png";
                    eye.alt = "Mostrar senha";
                    btn.setAttribute("aria-pressed", "true");
                } else {
                    input.type = "password";
                    eye.src = "../imagens/eye-close.png";
                    eye.alt = "Ocultar senha";
                    btn.setAttribute("aria-pressed", "false");
                }
            });
        })();
    </script>

    <script>
        const form = document.getElementById("reset-form");
        const passwordInput = document.getElementById("password");
        const confirmInput = document.getElementById("confirm-password");
        const messageEl = document.getElementById("message");

        // 1. Pegar o TOKEN da URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const password = passwordInput.value;
            const confirmPassword = confirmInput.value;

            // 2. Validar senhas
            if (password !== confirmPassword) {
                messageEl.textContent = "As senhas não coincidem!";
                messageEl.style.color = "red";
                return;
            }

            // 3. Validar token
            if (!token) {
                messageEl.textContent =
                    "Token inválido ou ausente. Solicite um novo link.";
                messageEl.style.color = "red";
                return;
            }

            messageEl.textContent = "Atualizando...";
            messageEl.style.color = "black";

            try {
                // 4. Enviar Token e Nova Senha para o backend
                const response = await fetch("/redefinir-senha", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        token: token,
                        password: password,
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    messageEl.textContent = data.message;
                    messageEl.style.color = "green";
                    // Redireciona para o login após 3 segundos
                    setTimeout(() => {
                        window.location.href = "/"; // Volta para a página de login
                    }, 3000);
                } else {
                    // Exibe erro (Ex: "Token inválido ou expirado")
                    messageEl.textContent = data.message;
                    messageEl.style.color = "red";
                }
            } catch (error) {
                console.error("Erro:", error);
                messageEl.textContent =
                    "Erro ao se conectar com o servidor. Tente novamente.";
                messageEl.style.color = "red";
            }
        });
    </script>
    </body>

</html>